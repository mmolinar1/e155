/*
author: Matthew Molinar
email: mmolinar@hmc.edu
date created: 09/27/2025
file: main.c

uses timer 15 for setting frequency and
timer 16 for setting duration of wave. This
allows for notes/music to be played using an
MCU.
*/

#include "STM32L432KC_RCC.h"
#include "STM32L432KC_GPIO.h"
#include "STM32L432KC_TIM.h"
#include "STM32L432KC_FLASH.h"

// Pitch in Hz, duration in ms
const int notes[][2] = {
  {659,	125},
  {623,	125},
  {659,	125},
  {623,	125},
  {659,	125},
  {494,	125},
  {587,	125},
  {523,	125},
  {440,	250},
  {  0,	125},
  {262,	125},
  {330,	125},
  {440,	125},
  {494,	250},
  {  0,	125},
  {330,	125},
  {416,	125},
  {494,	125},
  {523,	250},
  {  0,	125},
  {330,	125},
  {659,	125},
  {623,	125},
  {659,	125},
  {623,	125},
  {659,	125},
  {494,	125},
  {587,	125},
  {523,	125},
  {440,	250},
  {  0,	125},
  {262,	125},
  {330,	125},
  {440,	125},
  {494,	250},
  {  0,	125},
  {330,	125},
  {523,	125},
  {494,	125},
  {440,	250},
  {  0,	125},
  {494,	125},
  {523,	125},
  {587,	125},
  {659,	375},
  {392,	125},
  {699,	125},
  {659,	125},
  {587,	375},
  {349,	125},
  {659,	125},
  {587,	125},
  {523,	375},
  {330,	125},
  {587,	125},
  {523,	125},
  {494,	250},
  {  0,	125},
  {330,	125},
  {659,	125},
  {  0,	250},
  {659,	125},
  {1319,125},
  {  0,	250},
  {623,	125},
  {659,	125},
  {  0,	250},
  {623,	125},
  {659,	125},
  {623,	125},
  {659,	125},
  {623,	125},
  {659,	125},
  {494,	125},
  {587,	125},
  {523,	125},
  {440,	250},
  {  0,	125},
  {262,	125},
  {330,	125},
  {440,	125},
  {494,	250},
  {  0,	125},
  {330,	125},
  {416,	125},
  {494,	125},
  {523,	250},
  {  0,	125},
  {330,	125},
  {659,	125},
  {623,	125},
  {659,	125},
  {623,	125},
  {659,	125},
  {494,	125},
  {587,	125},
  {523,	125},
  {440,	250},
  {  0,	125},
  {262,	125},
  {330,	125},
  {440,	125},
  {494,	250},
  {  0,	125},
  {330,	125},
  {523,	125},
  {494,	125},
  {440,	500},
  {  0,	0}
};

//// Plasma by Dr. Gabba
const int plasma[][2] = {
    // Intro
    {392, 250},  // G4
    {440, 250},  // A4
    {523, 250},  // C5
    {587, 500},  // D5
    
    {392, 250},  // G4
    {440, 250},  // A4
    {523, 250},  // C5
    {698, 500},  // F5
    
    {392, 250},  // G4
    {440, 250},  // A4
    {523, 250},  // C5
    {783, 500},  // G5
    
    {698, 250},  // F5
    {587, 250},  // D5
    {523, 250},  // C5
    {440, 500},  // A4
    
    {523, 250},  // C5
    {587, 250},  // D5
    {659, 750},  // E5
    {587, 250},  // D5
    {523, 500},  // C5
    
    {440, 250},  // A4
    {523, 250},  // C5
    {587, 750},  // D5
    {523, 250},  // C5
    {440, 500},  // A4
    
    {392, 250},  // G4
    {440, 250},  // A4
    {523, 750},  // C5
    {440, 250},  // A4
    {392, 500},  // G4
    
    {349, 250},  // F4
    {392, 250},  // G4
    {440, 750},  // A4
    {349, 250},  // F4
    {392, 500},  // G4
   
    {523, 250},  // C5
    {587, 250},  // D5
    {659, 750},  // E5
    {587, 250},  // D5
    {698, 500},  // F5
    
    {659, 250},  // E5
    {587, 250},  // D5
    {523, 750},  // C5
    {587, 250},  // D5
    {523, 500},  // C5
    
    {440, 250},  // A4
    {523, 250},  // C5
    {587, 500},  // D5
    {523, 250},  // C5
    {440, 500},  // A4
    
    {392, 1000}, // G4
    {0, 500},    
    {0, 0}
};

int main(void) {
  // Configure flash to add waitstates to avoid timing errors
  configureFlash();
  configureClock();    // PLL

  //RCC->AHB2ENR |= (1 << 0);   // gpioa clk
  //RCC->APB2ENR |= (1 << 16); // TIM15
  //RCC->APB2ENR |= (1 << 17); // TIM16  
  //pinMode(6,GPIO_ALT); // GPIO config in ALT

  GPIO->AFRL &= ~(0b1111 << 24); 
  // set the 4 bits to 1110 (14) for AF14
  GPIO->AFRL |= (14 << 24); 


  //TIM15_init(5);       // Initialize TIM15 with prescaler=5
  //TIM16_init(700);     // Initialize TIM16 with prescaler=700

  //// play song
  //int i = 0;
  //while(notes[i][0] != 0 || notes[i][1] != 0) {
  //  int freq = notes[i][0];
  //  int dur = notes[i][1];

  //  if (freq > 0) {
  //    TIM15_set_frequency(freq);
  //    TIM16_set_duration(dur);
  //  } else {
  //    // silence
  //    TIM15->CCER &= ~1;          // disable output
  //    TIM16_set_duration(dur);
  //    TIM15->CCER |= 1;           // enable output
  //    }

  //    i++;
  //}
  //// stop timer
  //TIM15->CR1 &= ~1; 
}