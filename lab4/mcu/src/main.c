/*
author: Matthew Molinar
email: mmolinar@hmc.edu
date created: 09/27/2025
file: main.c

uses timer 15 for setting frequency and
timer 16 for setting duration of wave. This
allows for notes/music to be played using an
MCU.
*/

#include "STM32L432KC_RCC.h"
#include "STM32L432KC_GPIO.h"
#include "STM32L432KC_TIM.h"
#include "STM32L432KC_FLASH.h"

// Pitch in Hz, duration in ms
const int notes[][2] = {
  {659,	125},
  {623,	125},
  {659,	125},
  {623,	125},
  {659,	125},
  {494,	125},
  {587,	125},
  {523,	125},
  {440,	250},
  {  0,	125},
  {262,	125},
  {330,	125},
  {440,	125},
  {494,	250},
  {  0,	125},
  {330,	125},
  {416,	125},
  {494,	125},
  {523,	250},
  {  0,	125},
  {330,	125},
  {659,	125},
  {623,	125},
  {659,	125},
  {623,	125},
  {659,	125},
  {494,	125},
  {587,	125},
  {523,	125},
  {440,	250},
  {  0,	125},
  {262,	125},
  {330,	125},
  {440,	125},
  {494,	250},
  {  0,	125},
  {330,	125},
  {523,	125},
  {494,	125},
  {440,	250},
  {  0,	125},
  {494,	125},
  {523,	125},
  {587,	125},
  {659,	375},
  {392,	125},
  {699,	125},
  {659,	125},
  {587,	375},
  {349,	125},
  {659,	125},
  {587,	125},
  {523,	375},
  {330,	125},
  {587,	125},
  {523,	125},
  {494,	250},
  {  0,	125},
  {330,	125},
  {659,	125},
  {  0,	250},
  {659,	125},
  {1319,125},
  {  0,	250},
  {623,	125},
  {659,	125},
  {  0,	250},
  {623,	125},
  {659,	125},
  {623,	125},
  {659,	125},
  {623,	125},
  {659,	125},
  {494,	125},
  {587,	125},
  {523,	125},
  {440,	250},
  {  0,	125},
  {262,	125},
  {330,	125},
  {440,	125},
  {494,	250},
  {  0,	125},
  {330,	125},
  {416,	125},
  {494,	125},
  {523,	250},
  {  0,	125},
  {330,	125},
  {659,	125},
  {623,	125},
  {659,	125},
  {623,	125},
  {659,	125},
  {494,	125},
  {587,	125},
  {523,	125},
  {440,	250},
  {  0,	125},
  {262,	125},
  {330,	125},
  {440,	125},
  {494,	250},
  {  0,	125},
  {330,	125},
  {523,	125},
  {494,	125},
  {440,	500},
  {  0,	0}
};

// Twinkle Twinkle Little Star Theme
const int notes1[][2] = {
    {523, 400},  // C5
    {523, 400},  // C5
    {784, 400},  // G5
    {784, 400},  // G5
    {880, 400},  // A5
    {880, 400},  // A5
    {784, 800},  // G5
    
    {698, 400},  // F5
    {698, 400},  // F5
    {659, 400},  // E5
    {659, 400},  // E5
    {587, 400},  // D5
    {587, 400},  // D5
    {523, 800},  // C5
    
    {784, 400},  // G5
    {784, 400},  // G5
    {698, 400},  // F5
    {698, 400},  // F5
    {659, 400},  // E5
    {659, 400},  // E5
    {587, 800},  // D5
    
    {784, 400},  // G5
    {784, 400},  // G5
    {698, 400},  // F5
    {698, 400},  // F5
    {659, 400},  // E5
    {659, 400},  // E5
    {587, 800},  // D5
    
    {523, 400},  // C5
    {523, 400},  // C5
    {784, 400},  // G5
    {784, 400},  // G5
    {880, 400},  // A5
    {880, 400},  // A5
    {784, 800},  // G5
    
    {698, 400},  // F5
    {698, 400},  // F5
    {659, 400},  // E5
    {659, 400},  // E5
    {587, 400},  // D5
    {587, 400},  // D5
    {523, 800},  // C5
    {0, 0}
};

int main(void) {
  // Configure flash to add waitstates to avoid timing errors
  configureFlash();
  configureClock();    // PLL

  RCC->AHB2ENR |= (1 << 0);  // gpioa clk
  RCC->APB2ENR |= (1 << 16); // TIM15
  RCC->APB2ENR |= (1 << 17); // TIM16

  TIM15_init(5);       // Initialize TIM15 with prescaler=5
  TIM16_init(700);     // Initialize TIM16 with prescaler=700

  pinMode(2,2);     // GPIO PA2 config in ALT mode
  GPIO->AFRL &= ~(0b1111 << 8);   // Clear AF bits for PA2 (bit position 8-11)
  GPIO->AFRL |= (14 << 8);        // Set AF14 for PA2

  // play song
  int i = 0;
  while(notes1[i][0] != 0 || notes1[i][1] != 0) {
    int freq = notes1[i][0];
    int dur = notes1[i][1];

    if (freq > 0) {
      TIM15->CCER |= 1;           // enable output
      TIM15_set_frequency(freq);
      TIM16_set_duration(dur);
    } else {
      // silence
      TIM15->CCER &= ~1;          // disable output
      TIM16_set_duration(dur);
      }

      i++;
  }
  // stop timer
  TIM15->CR1 &= ~1; 
}